generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model HealthCheck {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
}

model User {
  id             String   @id @default(cuid())
  firebaseUserId String?  @unique
  email          String?  @unique
  phoneNumber    String?  @unique
  displayName    String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  ownedGames            Game[]         @relation("GameOwners")
  playerGames           GamePlayer[]
  createdGrids          Grid[]         @relation("GridCreator")
  squares               Square[]       @relation("SquarePlayer")
  notifications         Notification[] @relation("UserNotifications")
  triggeredNotifications Notification[] @relation("TriggeredNotifications")
}

model Game {
  id          String   @id @default(cuid())
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  gridId      String?  @unique

  owners        User[]         @relation("GameOwners")
  players       GamePlayer[]
  grid          Grid?          @relation("GameGrid", fields: [gridId], references: [id])
  notifications Notification[] @relation("GameNotifications")
}

model TempPlayer {
  id          String       @id @default(cuid())
  firstName   String
  lastName    String
  email       String?
  phoneNumber String?
  createdAt   DateTime     @default(now())

  gamePlayers GamePlayer[]
}

model GamePlayer {
  id         String   @id @default(cuid())
  gameId     String
  userId     String?
  tempUserId String?
  joinedAt   DateTime @default(now())

  game       Game        @relation(fields: [gameId], references: [id], onDelete: Cascade)
  user       User?       @relation(fields: [userId], references: [id], onDelete: Cascade)
  tempPlayer TempPlayer? @relation(fields: [tempUserId], references: [id], onDelete: Cascade)
  squares    Square[]    @relation("SquareGamePlayer")

  @@unique([gameId, userId])
  @@unique([gameId, tempUserId])
}

model Grid {
  id          String   @id @default(cuid())
  creatorId   String
  creator     User     @relation("GridCreator", fields: [creatorId], references: [id])
  rowOrder    Int[]
  columnOrder Int[]
  squares     Square[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  game        Game?    @relation("GameGrid")
}

model Square {
  id          String  @id @default(cuid())
  gridId      String
  grid        Grid    @relation(fields: [gridId], references: [id])
  rowIndex    Int
  columnIndex Int
  rowValue    Int
  columnValue Int
  playerId     String?
  player       User?       @relation("SquarePlayer", fields: [playerId], references: [id])
  gamePlayerId String?
  gamePlayer   GamePlayer? @relation("SquareGamePlayer", fields: [gamePlayerId], references: [id])

  @@unique([gridId, rowIndex, columnIndex])
}

enum NotificationAction {
  GAME_INVITE
  GAME_STARTED
  SQUARE_CLAIMED
  GAME_COMPLETED
  PLAYER_JOINED
  GRID_ASSIGNED
  GENERAL
}

model Notification {
  id                String             @id @default(cuid())
  userId            String
  user              User               @relation("UserNotifications", fields: [userId], references: [id], onDelete: Cascade)
  actionType        NotificationAction
  iconType          String
  title             String
  description       String
  metadata          Json?
  gameId            String?
  game              Game?              @relation("GameNotifications", fields: [gameId], references: [id], onDelete: SetNull)
  triggeredByUserId String?
  triggeredByUser   User?              @relation("TriggeredNotifications", fields: [triggeredByUserId], references: [id], onDelete: SetNull)
  createdAt         DateTime           @default(now())
  read              Boolean            @default(false)
}
