generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model HealthCheck {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
}

model User {
  id             String   @id @default(cuid())
  firebaseUserId String?  @unique
  email          String?  @unique
  phoneNumber    String?  @unique
  displayName    String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  ownedGrids             Grid[]         @relation("GridOwners")
  playerGames            GamePlayer[]
  createdGrids           Grid[]         @relation("GridCreator")
  notifications          Notification[] @relation("UserNotifications")
  triggeredNotifications Notification[] @relation("TriggeredNotifications")
}

model TempPlayer {
  id        String       @id @default(cuid())
  firstName String
  lastName  String
  createdAt DateTime     @default(now())

  gamePlayers GamePlayer[]
}

model GamePlayer {
  id         String   @id @default(cuid())
  gridId     String
  userId     String?
  tempUserId String?
  joinedAt   DateTime @default(now())

  grid       Grid        @relation(fields: [gridId], references: [id], onDelete: Cascade)
  user       User?       @relation(fields: [userId], references: [id], onDelete: Cascade)
  tempPlayer TempPlayer? @relation(fields: [tempUserId], references: [id], onDelete: Cascade)
  squares    Square[]    @relation("SquareGamePlayer")

  @@unique([gridId, userId])
  @@unique([gridId, tempUserId])
}

model Grid {
  id          String   @id @default(cuid())
  name        String
  description String?
  creatorId   String
  creator     User     @relation("GridCreator", fields: [creatorId], references: [id])
  rowOrder    Int[]
  columnOrder Int[]
  squares     Square[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  owners        User[]         @relation("GridOwners")
  players       GamePlayer[]
  notifications Notification[] @relation("GridNotifications")
}

model Square {
  id           String      @id @default(cuid())
  gridId       String
  grid         Grid        @relation(fields: [gridId], references: [id])
  rowIndex     Int
  columnIndex  Int
  rowValue     Int
  columnValue  Int
  gamePlayerId String?
  gamePlayer   GamePlayer? @relation("SquareGamePlayer", fields: [gamePlayerId], references: [id])

  @@unique([gridId, rowIndex, columnIndex])
}

enum NotificationAction {
  GAME_INVITE
  GAME_STARTED
  SQUARE_CLAIMED
  GAME_COMPLETED
  PLAYER_JOINED
  GRID_ASSIGNED
  GENERAL
}

model Notification {
  id                String             @id @default(cuid())
  userId            String
  user              User               @relation("UserNotifications", fields: [userId], references: [id], onDelete: Cascade)
  actionType        NotificationAction
  iconType          String
  title             String
  description       String
  metadata          Json?
  gridId            String?
  grid              Grid?              @relation("GridNotifications", fields: [gridId], references: [id], onDelete: SetNull)
  triggeredByUserId String?
  triggeredByUser   User?              @relation("TriggeredNotifications", fields: [triggeredByUserId], references: [id], onDelete: SetNull)
  createdAt         DateTime           @default(now())
  read              Boolean            @default(false)
}
